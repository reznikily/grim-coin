# Grim Coin - Быстрый старт

## Что реализовано

✅ **Децентрализованная сеть кошельков** на Go  
✅ **Две программы**: `make run-controller` и `make run-wallet`  
✅ **Таблица соответствия** IP, ID, баланс на всех узлах  
✅ **Выбор сетевого адаптера** при запуске кошелька  
✅ **Профиль кошелька** сохраняется локально  
✅ **Гарантированная доставка** сообщений HELLO с ACK-подтверждением  
✅ **Автоматическая синхронизация** таблицы при подключении новых узлов  
✅ **Транзакции** с командой `send <id> <n>`  
✅ **Распределенная блокировка** - никто не может совершать транзакции одновременно  
✅ **Гарантированная доставка** обновленной таблицы всем узлам  
✅ **HTML Dashboard** с WebSocket обновлениями в реальном времени  

## Установка и запуск

### 1. Установка зависимостей

```bash
make deps
```

### 2. Сборка

```bash
make build
```

## Запуск сети

### Шаг 1: Запуск контроллера

```bash
make run-controller
```

Контроллер предложит выбрать сетевой интерфейс:
```
Available network interfaces:
1. eth0 (192.168.1.100)
2. wlan0 (192.168.1.101)
Select interface (number): 1
```

После выбора контроллер запустится и выведет:
```
Controller started on 192.168.1.100
WebSocket server: ws://192.168.1.100:8080/ws
Dashboard: http://192.168.1.100:8081/dashboard.html
Listening for wallets...
```

### Шаг 2: Открыть Dashboard

Откройте в браузере: `http://192.168.1.100:8081/dashboard.html`

Dashboard показывает в реальном времени:
- Количество активных кошельков
- Общее количество монет
- Версию сети
- Список всех кошельков с балансами

### Шаг 3: Запуск кошельков

В других терминалах (можно на других машинах в той же сети):

```bash
make run-wallet
```

**При первом запуске:**
1. Выбрать сетевой интерфейс
2. Ввести ID (имя) кошелька
3. Профиль сохранится в `.wallet_profile.json`
4. Кошелек отправит HELLO всем в сети
5. Контроллер ответит и отправит текущую таблицу

**При следующих запусках:**
- Профиль загрузится автоматически
- Кошелек подключится к сети

## Использование кошелька

### Команды CLI

```bash
> balance
Your balance: 100 coins

> table
=== Network Table ===
Version: 3
Wallets:
  CONTROLLER (192.168.1.100): 0 coins
  Alice (192.168.1.101): 100 coins (YOU)
  Bob (192.168.1.102): 100 coins

> send Bob 25
Acquiring distributed lock...
Lock acquired, processing transaction...
Transaction broadcasted, syncing table...
Transaction completed successfully!

> balance
Your balance: 75 coins

> exit
Exiting...
```

## Как работают транзакции

1. **Блокировка**: Кошелек запрашивает блокировку у всех узлов
2. **Ожидание**: Ждет подтверждения от всех (5 секунд таймаут)
3. **Транзакция**: Отправляет транзакцию всем с гарантией доставки (5 попыток по 2 секунды)
4. **Синхронизация**: Рассылает обновленную таблицу всем с гарантией доставки
5. **Снятие блокировки**: Освобождает блокировку

Во время транзакции никто другой не может совершать операции.

## Протокол

### Сообщения

- `HELLO` → `HELLO_ACK` - объявление о присутствии
- `TABLE_SYNC` → `TABLE_ACK` - синхронизация таблицы
- `TRANSACTION` → `TX_ACK` - транзакция
- `LOCK_REQUEST` → `LOCK_GRANT` - запрос блокировки
- `LOCK_RELEASE` - снятие блокировки

### Гарантированная доставка

Критичные сообщения (HELLO, TABLE_SYNC, TRANSACTION) отправляются с:
- ACK-подтверждением
- Повторами (до 5 раз)
- Таймаутом 2 секунды на попытку

## Архитектура

```
grim-coin/
├── cmd/
│   ├── controller/main.go  # Контроллер сети
│   └── wallet/main.go      # Кошелек
├── bin/
│   ├── controller          # Скомпилированный контроллер
│   └── wallet              # Скомпилированный кошелек
├── dashboard.html          # Standalone HTML dashboard
├── Makefile                # Команды сборки
├── README.md               # Полная документация (English)
├── QUICKSTART.md           # Этот файл (Русский)
└── go.mod                  # Go зависимости
```

## Порты

- **9999** - UDP broadcast для всех сообщений
- **8080** - WebSocket сервер контроллера  
- **8081** - HTTP сервер dashboard

## Тестирование

### Сценарий 1: Локальное тестирование

1. Запустите контроллер в терминале 1
2. Откройте dashboard в браузере
3. Запустите кошелек "Alice" в терминале 2
4. Запустите кошелек "Bob" в терминале 3
5. В Alice: `send Bob 25`
6. Наблюдайте обновления в dashboard

### Сценарий 2: Сетевое тестирование

1. Запустите контроллер на машине A
2. Запустите кошельки на машинах B, C, D в той же локальной сети
3. Все узлы автоматически найдут друг друга через broadcast
4. Совершайте транзакции между кошельками

## Очистка

```bash
# Удалить бинарники и профиль
make clean

# Удалить только профиль кошелька (для создания нового)
rm .wallet_profile.json
```

## Особенности реализации

### 1. Broadcast обнаружение
Использует UDP broadcast на порт 9999 для обнаружения всех узлов в локальной сети.

### 2. Гарантированная доставка
Каждое критичное сообщение требует ACK. Если ACK не получен за 2 секунды - повтор.

### 3. Распределенная блокировка
Перед транзакцией узел запрашивает блокировку у всех. Транзакция начинается только после получения всех подтверждений.

### 4. Версионирование таблицы
Таблица имеет версию. При получении синхронизации принимается только более новая версия.

### 5. Реактивный Dashboard
WebSocket обновляет dashboard мгновенно при любых изменениях в сети.

## Решение проблем

### Контроллер не запускается
- Проверьте, что порты 9999, 8080, 8081 свободны
- Убедитесь, что firewall не блокирует UDP

### Кошелек не видит контроллер
- Убедитесь, что оба в одной подсети
- Проверьте, что выбран правильный сетевой интерфейс
- Broadcast должен работать в вашей сети

### Транзакции не проходят
- Проверьте баланс: `balance`
- Убедитесь, что все узлы видят друг друга: `table`
- Проверьте, что ID получателя правильный

### Dashboard не подключается
- Убедитесь, что контроллер запущен
- Откройте консоль браузера (F12) для отладки
- Проверьте URL WebSocket

## Дальнейшее развитие

Возможные улучшения:
- [ ] Персистентность данных (сохранение в БД)
- [ ] История транзакций
- [ ] Криптографические подписи
- [ ] Консенсус алгоритм (например, Raft)
- [ ] REST API для внешних систем
- [ ] Мобильное приложение
- [ ] Поддержка нескольких контроллеров (HA)

## Технологии

- **Go 1.21+** - основной язык
- **UDP broadcast** - обнаружение узлов
- **WebSocket** - реальное время для dashboard
- **gorilla/websocket** - WebSocket библиотека
- **google/uuid** - генерация уникальных ID
- **Vanilla JS** - frontend без зависимостей

---

**Создано для задачи по распределенным системам**  
Автор: AI Assistant  
Дата: 2025-10-04
